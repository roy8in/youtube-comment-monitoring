<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>NPS ì—¬ë¡  ëª¨ë‹ˆí„°ë§</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { background-color: #f0f2f5; padding-bottom: 50px; font-family: 'Pretendard', sans-serif; }
        .header-section { background: white; border-bottom: 1px solid #e1e4e8; padding: 2rem 0; margin-bottom: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .card { border: none; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 24px; }
        .card-header-custom { padding: 1.25rem 1.5rem; border-bottom: 1px solid #f0f0f0; background: transparent; }
        .card-title { font-weight: 700; color: #1a1a1a; margin-bottom: 0; font-size: 1.1rem; }
        
        /* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ì¶©ëŒ í•´ê²°: display: flex ì œê±° ë° position ì§€ì • */
        .chart-container { height: 400px; width: 100%; position: relative; }
        .empty-msg { color: #adb5bd; font-style: italic; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        
        .table-container { max-height: 600px; overflow-y: auto; }
        .table thead { position: sticky; top: 0; background: #f8f9fa; z-index: 1; }
        
        /* ì •ë ¬ ê¸°ëŠ¥ ìŠ¤íƒ€ì¼ */
        th.sortable { cursor: pointer; user-select: none; transition: background-color 0.2s; }
        th.sortable:hover { background-color: #e2e6ea; }
        .sort-icon { font-size: 0.8rem; color: #adb5bd; margin-left: 5px; }

        .sentiment-badge { padding: 4px 10px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; display: inline-block; width: 60px; text-align: center; }
        .pos { background: #e6fffa; color: #00cc96; }
        .neg { background: #fff5f5; color: #ef553b; }
        .neu { background: #f0f5ff; color: #636efa; }
        
        @media (max-width: 768px) {
            body { font-size: 18px; }
            .header-section h2 { font-size: 1.8rem !important; }
            .sentiment-badge { font-size: 1.1rem; padding: 8px 16px; width: 70px; }
            .table { font-size: 1.1rem; }
            .small { font-size: 1.05rem !important; }
        }
        .footer { background: white; border-top: 1px solid #e1e4e8; padding: 2rem 0; margin-top: 3rem; color: #6c757d; font-size: 0.85rem; }
        .disclaimer-list { list-style: none; padding-left: 0; margin-bottom: 0; display: inline-block; text-align: left; }
        .disclaimer-list li { margin-bottom: 4px; }
        .disclaimer-list li::before { content: "â€¢"; margin-right: 8px; color: #adb5bd; }
    </style>
</head>
<body>
    <div class="header-section text-center">
        <div class="container">
            <h2 class="fw-bold text-primary mb-1">ğŸ“Š êµ­ë¯¼ì—°ê¸ˆ ìœ íŠœë¸Œ ì—¬ë¡  ëª¨ë‹ˆí„°ë§</h2>
            <div class="video-info p-3 border rounded-3 bg-light d-inline-block shadow-sm">
                <span class="d-block text-muted small mb-1">ë¶„ì„ ëŒ€ìƒ ì˜ìƒ:</span>
                <a href="https://youtu.be/fNHLffyXnQM" target="_blank" class="text-decoration-none fw-bold text-dark d-block">
                    ğŸ¥ ìµœëŒ€ í°ì† êµ­ë¯¼ì—°ê¸ˆ, ë³¸ê²© ì½”ìŠ¤ë‹¥ íˆ¬ì ì„ë°•? | ê¹€ì„±ì£¼ êµ­ë¯¼ì—°ê¸ˆê³µë‹¨ ì´ì‚¬ì¥ [ë” í”¼í”Œ]
                </a>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <div class="card-header-custom"><h5 class="card-title">ğŸ“ˆ ì‹œê°„ëŒ€ë³„ ëˆ„ì  ì¡°íšŒìˆ˜ ì¶”ì´</h5></div>
            <div class="card-body"><div id="viewChart" class="chart-container"><div class="empty-msg">ë°ì´í„° ë¡œë“œ ì¤‘...</div></div></div>
        </div>

        <div class="row">
            <div class="col-lg-5">
                <div class="card">
                    <div class="card-header-custom"><h5 class="card-title">ğŸ˜Š ì „ì²´ ê°ì„± ë¶„í¬</h5></div>
                    <div class="card-body"><div id="sentimentChart" class="chart-container"><div class="empty-msg">ë°ì´í„° ë¡œë“œ ì¤‘...</div></div></div>
                </div>
            </div>
            <div class="col-lg-7">
                <div class="card">
                    <div class="card-header-custom"><h5 class="card-title">ğŸ“Š ë¶„ë¥˜ë³„ ì—¬ë¡  (ê¸ì •/ë¶€ì •/ì¤‘ë¦½)</h5></div>
                    <div class="card-body"><div id="categoryChart" class="chart-container"><div class="empty-msg">ë°ì´í„° ë¡œë“œ ì¤‘...</div></div></div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header-custom d-flex justify-content-between align-items-center">
                <h5 class="card-title">ğŸ“ ì „ì²´ ë¶„ì„ ë°ì´í„°</h5>
                <span class="badge bg-light text-dark border">í—¤ë”ë¥¼ í´ë¦­í•´ ì •ë ¬í•˜ì„¸ìš”</span>
            </div>
            <div class="card-body p-0">
                <div class="table-container">
                    <table class="table table-hover align-middle mb-0" id="dataTable">
                        <thead>
                            <tr>
                                <th class="sortable" data-index="0" style="width: 120px; padding-left: 1.5rem;">ê°ì„± <span class="sort-icon">â†•</span></th>
                                <th class="sortable" data-index="1" style="width: 140px;">ë¶„ë¥˜ <span class="sort-icon">â†•</span></th>
                                <th class="sortable" data-index="2" style="width: 150px;">í‚¤ì›Œë“œ <span class="sort-icon">â†•</span></th>
                                <th>ëŒ“ê¸€ ë‚´ìš©</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container text-center">
            <p class="fw-bold mb-2 text-dark">âš ï¸ ë©´ì±…ì¡°í•­ (Disclaimer)</p>
            <ul class="disclaimer-list">
                <li>ë³¸ ëŒ€ì‹œë³´ë“œì˜ ë°ì´í„°ëŠ” ìœ íŠœë¸Œ APIë¥¼ í†µí•´ ìë™ ìˆ˜ì§‘ë˜ì—ˆìœ¼ë©°, ì‹¤ì œ ì„œë¹„ìŠ¤ìƒì˜ ìˆ˜ì¹˜ì™€ ì°¨ì´ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                <li>ëŒ“ê¸€ ë¶„ì„ ê²°ê³¼ëŠ” AI(GPT-4o-mini)ì— ì˜í•´ ìƒì„±ëœ ê²ƒìœ¼ë¡œ, ì‹¤ì œ ì‘ì„±ìì˜ ì˜ë„ë‚˜ ê³µë‹¨ì˜ ê³µì‹ ì…ì¥ê³¼ëŠ” ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                <li>ì œê³µë˜ëŠ” ëª¨ë“  ì •ë³´ëŠ” ì°¸ê³ ìš©ì´ë©°, ì´ë¥¼ ê·¼ê±°ë¡œ í•œ íŒë‹¨ì— ëŒ€í•œ ì±…ì„ì€ ì‚¬ìš©ìì—ê²Œ ìˆìŠµë‹ˆë‹¤.</li>
            </ul>
        </div>
    </footer>

    <script>
        const config = { responsive: true, displayModeBar: false };
        const colorMap = { 'ê¸ì •': '#00CC96', 'ë¶€ì •': '#EF553B', 'ì¤‘ë¦½': '#636EFA' };
        const isMobile = window.innerWidth < 768;
        const chartFontSize = isMobile ? 18 : 13;

        // 1. ì¡°íšŒìˆ˜ ë°ì´í„° ë¡œë“œ
        Papa.parse("video_stats.csv?v=" + new Date().getTime(), {
            download: true, header: true, skipEmptyLines: true,
            complete: function(results) {
                const data = results.data.filter(d => d.timestamp && d.view_count);
                if (data.length === 0) return;
                
                const trace = {
                    x: data.map(d => d.timestamp),
                    y: data.map(d => d.view_count),
                    type: 'scatter', mode: 'lines+markers',
                    line: {color: '#4e73df', width: 3, shape: 'spline'},
                    fill: 'tozeroy', fillcolor: 'rgba(78, 115, 223, 0.05)'
                };
                document.getElementById('viewChart').innerHTML = ""; // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                Plotly.newPlot('viewChart', [trace], {
                    margin: {t:20, b:40, l:60, r:20},
                    autosize: true,
                    xaxis: { tickfont: {size: chartFontSize} },
                    yaxis: { tickfont: {size: chartFontSize} }
                }, config);
            }
        });

        // 2. ë¶„ì„ ë°ì´í„° ë¡œë“œ (ì°¨íŠ¸ ë° í…Œì´ë¸”)
        Papa.parse("analyzed_comments.csv?v=" + new Date().getTime(), {
            download: true, header: true, skipEmptyLines: true,
            complete: function(results) {
                const rawData = results.data.filter(d => d.sentiment && d.text);
                const data = rawData.filter(d => d.keyword !== 'ê´‘ê³ ' && d.sentiment !== 'ê´‘ê³ ');
                if (data.length === 0) return;

                // --- [ê°ì„± íŒŒì´ ì°¨íŠ¸] ---
                const sCounts = { 'ê¸ì •': 0, 'ë¶€ì •': 0, 'ì¤‘ë¦½': 0 };
                data.forEach(d => { if(sCounts[d.sentiment] !== undefined) sCounts[d.sentiment]++; });
                
                document.getElementById('sentimentChart').innerHTML = ""; // ë¡œë”© ì œê±°
                Plotly.newPlot('sentimentChart', [{
                    values: Object.values(sCounts), labels: Object.keys(sCounts), type: 'pie', hole: 0.5,
                    marker: { colors: Object.keys(sCounts).map(k => colorMap[k]) },
                    textfont: { size: chartFontSize + 2 }
                }], { 
                    margin: {t:20, b:20, l:20, r:20},
                    autosize: true
                }, config);

                // --- [ë¶„ë¥˜ë³„ ìŠ¤íƒ ë°” ì°¨íŠ¸] ---
                const catCounts = {};
                data.forEach(d => {
                    const cat = d.category || 'ê¸°íƒ€';
                    if (!catCounts[cat]) catCounts[cat] = { 'ê¸ì •': 0, 'ë¶€ì •': 0, 'ì¤‘ë¦½': 0 };
                    if (catCounts[cat][d.sentiment] !== undefined) catCounts[cat][d.sentiment]++;
                });

                // ì´ ë¹ˆë„ìˆ˜ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ (ê°€ë¡œ ë§‰ëŒ€ ì°¨íŠ¸ì—ì„œëŠ” í° ê°’ì´ ìœ„ì— ì˜¤ë„ë¡)
                const sortedCats = Object.keys(catCounts).sort((a, b) => {
                    const sumA = catCounts[a]['ê¸ì •'] + catCounts[a]['ë¶€ì •'] + catCounts[a]['ì¤‘ë¦½'];
                    const sumB = catCounts[b]['ê¸ì •'] + catCounts[b]['ë¶€ì •'] + catCounts[b]['ì¤‘ë¦½'];
                    return sumA - sumB; 
                });

                const tracePos = { x: sortedCats.map(c => catCounts[c]['ê¸ì •']), y: sortedCats, name: 'ê¸ì •', type: 'bar', orientation: 'h', marker: {color: colorMap['ê¸ì •']} };
                const traceNeg = { x: sortedCats.map(c => catCounts[c]['ë¶€ì •']), y: sortedCats, name: 'ë¶€ì •', type: 'bar', orientation: 'h', marker: {color: colorMap['ë¶€ì •']} };
                const traceNeu = { x: sortedCats.map(c => catCounts[c]['ì¤‘ë¦½']), y: sortedCats, name: 'ì¤‘ë¦½', type: 'bar', orientation: 'h', marker: {color: colorMap['ì¤‘ë¦½']} };

                document.getElementById('categoryChart').innerHTML = ""; // ë¡œë”© ì œê±°
                Plotly.newPlot('categoryChart', [tracePos, traceNeg, traceNeu], {
                    barmode: 'stack',
                    margin: {t:20, b:60, l:90, r:20}, // ë²”ë¡€ì™€ ê²¹ì¹˜ì§€ ì•Šë„ë¡ bottom/left margin í™•ë³´
                    autosize: true,
                    xaxis: { tickfont: {size: chartFontSize} },
                    yaxis: { tickfont: {size: chartFontSize} },
                    legend: { orientation: 'h', y: -0.2, x: 0.5, xanchor: 'center' } // ë²”ë¡€ë¥¼ ì°¨íŠ¸ í•˜ë‹¨ ì¤‘ì•™ìœ¼ë¡œ ë°°ì¹˜
                }, config);

                // --- [í…Œì´ë¸” ì—…ë°ì´íŠ¸] ---
                const tbody = document.querySelector("#dataTable tbody");
                [...data].reverse().forEach(d => {
                    const cls = d.sentiment === 'ê¸ì •' ? 'pos' : (d.sentiment === 'ë¶€ì •' ? 'neg' : 'neu');
                    tbody.innerHTML += `<tr>
                        <td style="padding-left: 1.5rem;"><span class="sentiment-badge ${cls}">${d.sentiment}</span></td>
                        <td><span class="badge bg-secondary">${d.category || 'ê¸°íƒ€'}</span></td>
                        <td class="fw-bold text-truncate" style="max-width: 150px;">${d.keyword || '-'}</td>
                        <td class="text-dark small">${d.text}</td>
                    </tr>`;
                });

                // --- [í…Œì´ë¸” ì»¬ëŸ¼ ì •ë ¬ (Sorting)] ---
                document.querySelectorAll('th.sortable').forEach(th => {
                    th.addEventListener('click', () => {
                        const table = th.closest('table');
                        const tableBody = table.querySelector('tbody');
                        const rows = Array.from(tableBody.querySelectorAll('tr'));
                        const index = parseInt(th.getAttribute('data-index'));
                        const isAsc = th.classList.contains('asc');

                        rows.sort((a, b) => {
                            const valA = a.children[index].innerText.trim();
                            const valB = b.children[index].innerText.trim();
                            return isAsc ? valB.localeCompare(valA) : valA.localeCompare(valB);
                        });

                        // ë°©í–¥ ì•„ì´ì½˜ í† ê¸€
                        table.querySelectorAll('th.sortable').forEach(header => {
                            header.classList.remove('asc', 'desc');
                            header.querySelector('.sort-icon').innerText = 'â†•';
                        });
                        th.classList.toggle('asc', !isAsc);
                        th.classList.toggle('desc', isAsc);
                        th.querySelector('.sort-icon').innerText = isAsc ? 'â†‘' : 'â†“';

                        // ì¬ë°°ì¹˜
                        tableBody.innerHTML = '';
                        rows.forEach(row => tableBody.appendChild(row));
                    });
                });
            }
        });
    </script>
</body>
</html>