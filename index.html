<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>NPS ì—¬ë¡  ëª¨ë‹ˆí„°ë§</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; padding: 20px; font-family: 'Pretendard', sans-serif; }
        .card { margin-bottom: 25px; border: none; border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.05); }
        .table thead { background-color: #ebf0f5; }
        /* ê°ì„± ì¹¸ ì¤„ë°”ê¿ˆ ë°©ì§€ ë° ë„ˆë¹„ í™•ë³´ */
        .col-sentiment { white-space: nowrap; width: 100px; text-align: center; font-weight: bold; }
        .col-keyword { width: 150px; font-weight: 500; }
        .chart-container { min-height: 400px; }
    </style>
</head>
<body>
    <div class="container-fluid shadow-sm p-3 mb-5 bg-white rounded">
        <h2 class="text-center fw-bold text-primary">ğŸ“Š êµ­ë¯¼ì—°ê¸ˆ ìœ íŠœë¸Œ ì—¬ë¡  ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</h2>
        <p class="text-center text-muted">êµ­ë¯¼ì—°ê¸ˆê³µë‹¨ í™ë³´ì‹¤ ì–¸ë¡ í™ë³´ë¶€</p>
    </div>

    <div class="container">
        <div class="card p-4">
            <div id="viewChart" class="chart-container"></div>
        </div>

        <div class="row">
            <div class="col-lg-6">
                <div class="card p-4">
                    <div id="sentimentChart" class="chart-container"></div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card p-4">
                    <div id="keywordChart" class="chart-container"></div>
                </div>
            </div>
        </div>

        <div class="card p-4">
            <h4 class="fw-bold mb-3">ğŸ“ ìµœê·¼ ë¶„ì„ ë°ì´í„° (Top 30)</h4>
            <div class="table-responsive">
                <table class="table table-hover align-middle" id="dataTable">
                    <thead>
                        <tr>
                            <th class="col-sentiment">ê°ì„±</th>
                            <th class="col-keyword">í‚¤ì›Œë“œ</th>
                            <th>ë‚´ìš©</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const config = { responsive: true };

        // 1. ì˜ìƒ í†µê³„ (ì¡°íšŒìˆ˜)
        Papa.parse("video_stats.csv", {
            download: true, header: true, complete: function(results) {
                const data = results.data.filter(d => d.timestamp);
                const trace = {
                    x: data.map(d => d.timestamp),
                    y: data.map(d => d.view_count),
                    type: 'scatter', mode: 'lines+markers', name: 'ì¡°íšŒìˆ˜',
                    line: {color: '#007bff', width: 3},
                    marker: {size: 8}
                };
                const layout = { title: '<b>ì‹œê°„ëŒ€ë³„ ëˆ„ì  ì¡°íšŒìˆ˜ ì¶”ì´</b>', margin: {t:50, b:50, l:50, r:20} };
                Plotly.newPlot('viewChart', [trace], layout, config);
            }
        });

        // 2. ê°ì„± ë° í‚¤ì›Œë“œ ë¶„ì„
        Papa.parse("analyzed_comments.csv", {
            download: true, header: true, complete: function(results) {
                const data = results.data.filter(d => d.sentiment);
                
                // [ê°ì„± ì°¨íŠ¸ ë°ì´í„°]
                const sCounts = {};
                data.forEach(d => sCounts[d.sentiment] = (sCounts[d.sentiment] || 0) + 1);
                const pieData = [{
                    values: Object.values(sCounts),
                    labels: Object.keys(sCounts),
                    type: 'pie',
                    hole: 0.4,
                    marker: {colors: ['#EF553B', '#00CC96', '#636EFA']} // ë¶€ì •, ê¸ì •, ì¤‘ë¦½ ìˆœì„œ ëŒ€ì‘ í•„ìš”ì‹œ ì¡°ì •
                }];
                Plotly.newPlot('sentimentChart', pieData, {title: '<b>ì „ì²´ ê°ì„± ë¶„í¬</b>'}, config);

                // [í‚¤ì›Œë“œ ì°¨íŠ¸ ë°ì´í„° - ê°€ë¡œ ë°” ì°¨íŠ¸]
                const kCounts = {};
                data.forEach(d => { if(d.keyword) kCounts[d.keyword] = (kCounts[d.keyword] || 0) + 1; });
                const sortedK = Object.entries(kCounts).sort((a,b) => b[1] - a[1]).slice(0, 10);
                
                const barData = [{
                    x: sortedK.map(d => d[1]),
                    y: sortedK.map(d => d[0]),
                    type: 'bar', orientation: 'h',
                    marker: {color: '#636EFA'}
                }];
                Plotly.newPlot('keywordChart', barData, {
                    title: '<b>í•µì‹¬ í‚¤ì›Œë“œ Top 10</b>',
                    yaxis: {autorange: 'reversed'},
                    margin: {l: 100}
                }, config);

                // [í…Œì´ë¸” ì—…ë°ì´íŠ¸]
                const tbody = document.querySelector("#dataTable tbody");
                data.reverse().slice(0, 30).forEach(d => {
                    let sColor = "#636EFA"; // ì¤‘ë¦½
                    if(d.sentiment === 'ê¸ì •') sColor = "#00CC96";
                    if(d.sentiment === 'ë¶€ì •') sColor = "#EF553B";
                    
       return {
        "title": item['snippet']['title'],
        "view_count": int(stats.get('viewCount', 0)),
        "like_count": int(stats.get('likeCount', 0)),
        "comment_count": int(stats.get('commentCount', 0)),
        "timestamp": datetime.now().strftime('%Y-%m-%d %H:%M:%S') # ì´ì œ KSTë¡œ ì°í™ë‹ˆë‹¤
    }             const row = `<tr>
                        <td class="col-sentiment" style="color:${sColor}">${d.sentiment}</td>
                        <td class="col-keyword text-truncate">${d.keyword || '-'}</td>
                        <td class="small text-muted">${d.text}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            }
        });
    </script>
</body>
</html>
