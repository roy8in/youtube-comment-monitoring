<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>NPS ì—¬ë¡  ëª¨ë‹ˆí„°ë§</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { background-color: #f0f2f5; padding-bottom: 50px; font-family: 'Pretendard', sans-serif; }
        .header-section { background: white; border-bottom: 1px solid #e1e4e8; padding: 2rem 0; margin-bottom: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .card { border: none; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 24px; transition: transform 0.2s; }
        .card-header-custom { padding: 1.25rem 1.5rem; border-bottom: 1px solid #f0f0f0; background: transparent; }
        .card-title { font-weight: 700; color: #1a1a1a; margin-bottom: 0; font-size: 1.1rem; }
        .chart-container { height: 400px; width: 100%; }
        .table-container { max-height: 600px; overflow-y: auto; }
        .table thead { position: sticky; top: 0; background: #f8f9fa; z-index: 1; }
        .sentiment-badge { padding: 4px 10px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; display: inline-block; }
        .pos { background: #e6fffa; color: #00cc96; }
        .neg { background: #fff5f5; color: #ef553b; }
        .neu { background: #f0f5ff; color: #636efa; }
        .empty-msg { color: #adb5bd; display: flex; align-items: center; justify-content: center; height: 100%; font-style: italic; }
        
        /* ëª¨ë°”ì¼ ê°€ë…ì„± í–¥ìƒì„ ìœ„í•œ ë¯¸ë””ì–´ ì¿¼ë¦¬ */
        @media (max-width: 768px) {
            body { font-size: 18px; }
            .header-section { padding: 1.5rem 0; }
            .header-section h2 { font-size: 1.8rem !important; }
            .card-title { font-size: 1.3rem !important; }
            .sentiment-badge { font-size: 1.1rem; padding: 8px 16px; }
            .table { font-size: 1.1rem; }
            .table-container { max-height: 500px; }
            .small { font-size: 1.05rem !important; }
            .fw-bold { font-size: 1.2rem; }
        }
    </style>
</head>
<body>
    <div class="header-section text-center">
        <div class="container">
            <h2 class="fw-bold text-primary mb-1">ğŸ“Š êµ­ë¯¼ì—°ê¸ˆ ìœ íŠœë¸Œ ì—¬ë¡  ëª¨ë‹ˆí„°ë§</h2>
            <div class="video-info p-3 border rounded-3 bg-light d-inline-block shadow-sm">
                <span class="d-block text-muted small mb-1">ë¶„ì„ ëŒ€ìƒ ì˜ìƒ:</span>
                <a href="https://youtu.be/fNHLffyXnQM" target="_blank" class="text-decoration-none fw-bold text-dark d-block" style="font-size: 1rem; max-width: 600px;">
                    ğŸ¥ ìµœëŒ€ í°ì† êµ­ë¯¼ì—°ê¸ˆ, ë³¸ê²© ì½”ìŠ¤ë‹¥ íˆ¬ì ì„ë°•? | ê¹€ì„±ì£¼ êµ­ë¯¼ì—°ê¸ˆê³µë‹¨ ì´ì‚¬ì¥ [ë” í”¼í”Œ]
                </a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 1. ì‹œê°„ëŒ€ë³„ ì¡°íšŒìˆ˜ (ì „ì²´ ë„ˆë¹„) -->
        <div class="card">
            <div class="card-header-custom">
                <h5 class="card-title">ğŸ“ˆ ì‹œê°„ëŒ€ë³„ ëˆ„ì  ì¡°íšŒìˆ˜ ì¶”ì´</h5>
            </div>
            <div class="card-body">
                <div id="viewChart" class="chart-container"><div class="empty-msg">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>
            </div>
        </div>

        <div class="row">
            <!-- 2. ê°ì„± ë¶„ì„ (ì¢Œì¸¡) -->
            <div class="col-lg-5">
                <div class="card">
                    <div class="card-header-custom">
                        <h5 class="card-title">ğŸ˜Š ì „ì²´ ê°ì„± ë¶„í¬</h5>
                    </div>
                    <div class="card-body">
                        <div id="sentimentChart" class="chart-container"></div>
                    </div>
                </div>
            </div>
            <!-- 3. í•µì‹¬ í‚¤ì›Œë“œ (ìš°ì¸¡) -->
            <div class="col-lg-7">
                <div class="card">
                    <div class="card-header-custom">
                        <h5 class="card-title">ğŸ” í•µì‹¬ í‚¤ì›Œë“œ Top 10</h5>
                    </div>
                    <div class="card-body">
                        <div id="keywordChart" class="chart-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. ìƒì„¸ ë¶„ì„ í…Œì´ë¸” -->
        <div class="card">
            <div class="card-header-custom d-flex justify-content-between align-items-center">
                <h5 class="card-title">ğŸ“ ì „ì²´ ë¶„ì„ ë°ì´í„°</h5>
                <span class="badge bg-light text-dark">ìµœì‹ ìˆœ ì •ë ¬</span>
            </div>
            <div class="card-body p-0">
                <div class="table-container">
                    <table class="table table-hover align-middle mb-0" id="dataTable">
                        <thead>
                            <tr>
                                <th style="width: 120px; padding-left: 1.5rem;">ê°ì„±</th>
                                <th style="width: 150px;">í‚¤ì›Œë“œ</th>
                                <th>ëŒ“ê¸€ ë‚´ìš©</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const config = { responsive: true, displayModeBar: false };
        const colorMap = { 'ê¸ì •': '#00CC96', 'ë¶€ì •': '#EF553B', 'ì¤‘ë¦½': '#636EFA', 'ì˜¤ë¥˜': '#AB63FA' };
        
        // ëª¨ë°”ì¼ ì—¬ë¶€ì— ë”°ë¼ ì°¨íŠ¸ í°íŠ¸ í¬ê¸° ê²°ì • (ê¸°ì¡´ë³´ë‹¤ 50% ì¦ëŒ€)
        const isMobile = window.innerWidth < 768;
        const chartFontSize = isMobile ? 24 : 18;
        const chartFont = { family: 'Pretendard, sans-serif', size: chartFontSize };

        // 1. ì˜ìƒ í†µê³„ ë¡œë“œ
        Papa.parse("video_stats.csv", {
            download: true, header: true, skipEmptyLines: true,
            complete: function(results) {
                const data = results.data.filter(d => d.timestamp && d.view_count);
                if (data.length === 0) return;

                const trace = {
                    x: data.map(d => d.timestamp),
                    y: data.map(d => d.view_count),
                    type: 'scatter', mode: 'lines+markers',
                    line: {color: '#4e73df', width: isMobile ? 4 : 3, shape: 'spline'},
                    marker: {size: isMobile ? 8 : 6},
                    fill: 'tozeroy', fillcolor: 'rgba(78, 115, 223, 0.05)'
                };
                const layout = {
                    margin: {t:20, b:60, l:70, r:20},
                    xaxis: { gridcolor: '#f0f0f0', tickfont: {size: chartFontSize} },
                    yaxis: { gridcolor: '#f0f0f0', tickfont: {size: chartFontSize} },
                    font: chartFont,
                    autosize: true
                };
                document.getElementById('viewChart').innerHTML = "";
                Plotly.newPlot('viewChart', [trace], layout, config);
            }
        });

        // 2. ëŒ“ê¸€ ë¶„ì„ ë°ì´í„° ë¡œë“œ
        Papa.parse("analyzed_comments.csv", {
            download: true, header: true, skipEmptyLines: true,
            complete: function(results) {
                // 'ê´‘ê³ ' í‚¤ì›Œë“œ ì œì™¸ í•„í„°ë§ ì¶”ê°€
                const rawData = results.data.filter(d => d.sentiment && d.text);
                const data = rawData.filter(d => d.keyword !== 'ê´‘ê³ ');
                
                if (data.length === 0) return;

                // [ê°ì„± ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„]
                const sCounts = { 'ê¸ì •': 0, 'ë¶€ì •': 0, 'ì¤‘ë¦½': 0 };
                data.forEach(d => { if(sCounts[d.sentiment] !== undefined) sCounts[d.sentiment]++; });
                
                const pieData = [{
                    values: Object.values(sCounts),
                    labels: Object.keys(sCounts),
                    type: 'pie',
                    hole: 0.5,
                    marker: { colors: Object.keys(sCounts).map(k => colorMap[k]) },
                    textinfo: 'label+percent',
                    hoverinfo: 'label+value',
                    textfont: { size: chartFontSize + 2 }
                }];
                Plotly.newPlot('sentimentChart', pieData, { 
                    margin: {t:30, b:30, l:30, r:30},
                    font: chartFont,
                    legend: { font: {size: chartFontSize} }
                }, config);

                // [í‚¤ì›Œë“œ ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„]
                const kCounts = {};
                data.forEach(d => { if(d.keyword) kCounts[d.keyword] = (kCounts[d.keyword] || 0) + 1; });
                const sortedK = Object.entries(kCounts).sort((a,b) => b[1] - a[1]).slice(0, 10).reverse();
                
                const barData = [{
                    x: sortedK.map(d => d[1]),
                    y: sortedK.map(d => d[0]),
                    type: 'bar', orientation: 'h',
                    marker: { color: '#4e73df', opacity: 0.8 }
                }];
                Plotly.newPlot('keywordChart', barData, {
                    margin: {t:10, b:50, l:isMobile ? 100 : 120, r:20},
                    font: chartFont,
                    xaxis: { title: 'ë¹ˆë„ìˆ˜', gridcolor: '#f0f0f0', titlefont: {size: chartFontSize}, tickfont: {size: chartFontSize} },
                    yaxis: { tickfont: {size: chartFontSize} }
                }, config);

                // [í…Œì´ë¸” ì—…ë°ì´íŠ¸]
                const tbody = document.querySelector("#dataTable tbody");
                tbody.innerHTML = "";
                [...data].reverse().forEach(d => {
                    const cls = d.sentiment === 'ê¸ì •' ? 'pos' : (d.sentiment === 'ë¶€ì •' ? 'neg' : 'neu');
                    const row = `<tr>
                        <td style="padding-left: 1.5rem;"><span class="sentiment-badge ${cls}">${d.sentiment}</span></td>
                        <td class="fw-bold">${d.keyword || '-'}</td>
                        <td class="text-dark">${d.text}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            }
        });
    </script>
</body>
</html>
